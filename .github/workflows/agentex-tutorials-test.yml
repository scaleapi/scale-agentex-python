name: Test Tutorial Agents

on:
  workflow_dispatch:

jobs:
  test-tutorials:
    timeout-minutes: 15
    name: test-tutorial-${{ matrix.tutorial }}
    runs-on: ubuntu-latest

    steps:
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Checkout scale-agentex repo
        uses: actions/checkout@v4
        with:
          repository: scaleapi/scale-agentex
          path: scale-agentex

      - name: Navigate to scale-agentex repo
        run: |
          cd scale-agentex/agentex
          echo "üöÄ Starting dependencies (Postgres, Redis, Temporal, MongoDB)..."

          # Start all services except the agentex service
          docker compose up -d

          echo "‚è≥ Waiting for dependencies to be healthy..."

          # Wait for services to be healthy
          for i in {1..30}; do
            if docker compose ps | grep -q "healthy"; then
              echo "‚úÖ Dependencies are healthy"
              break
            fi
            echo "  Attempt $i/30: Waiting for services..."
            sleep 5
          done

          # Verify all deps are up
          docker compose ps
