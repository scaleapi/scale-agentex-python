"""
Tests for {{ agent_name }} (temporal agent)

This test suite demonstrates testing your temporal agent with the AgentEx testing framework.

Test coverage:
- Basic event sending and polling
- Streaming responses
- Multi-turn conversations
- Workflow execution

Prerequisites:
    - AgentEx services running (make dev)
    - Temporal server running
    - Agent running: agentex agents run --manifest manifest.yaml

Run tests:
    pytest tests/test_agent.py -v

Note: Temporal agents may need longer timeouts due to workflow orchestration overhead.
"""

import pytest

from agentex.lib.testing import (
    test_agentic_agent,
    assert_valid_agent_response,
    assert_agent_response_contains,
    stream_agent_response,
    stream_task_messages,
)

AGENT_NAME = "{{ agent_name }}"


@pytest.mark.asyncio
async def test_agent_basic_response():
    """Test that agent responds to basic events."""
    async with test_agentic_agent(agent_name=AGENT_NAME) as test:
        response = await test.send_event(
            "Hello! Please respond briefly.",
            timeout_seconds=60.0  # Temporal agents may need more time
        )

        assert_valid_agent_response(response)
        assert len(response.content) > 0
        print(f"✓ Agent responded: {response.content[:80]}...")


@pytest.mark.asyncio
async def test_agent_multi_turn():
    """Test multi-turn conversation."""
    async with test_agentic_agent(agent_name=AGENT_NAME) as test:
        # Turn 1
        response1 = await test.send_event("Hello!", timeout_seconds=60.0)
        assert_valid_agent_response(response1)

        # Turn 2
        response2 = await test.send_event("How are you?", timeout_seconds=60.0)
        assert_valid_agent_response(response2)

        # Turn 3
        response3 = await test.send_event("Thank you!", timeout_seconds=60.0)
        assert_valid_agent_response(response3)

        # Verify history
        history = await test.get_conversation_history()
        assert len(history) >= 6, f"Expected >= 6 messages, got {len(history)}"
        print(f"✓ Conversation: {len(history)} messages")


@pytest.mark.asyncio
async def test_agent_streaming():
    """Test streaming responses from temporal agent."""
    async with test_agentic_agent(agent_name=AGENT_NAME) as test:
        # Send initial event
        await test.send_event("Start workflow", timeout_seconds=60.0)

        # Stream subsequent events
        events_received = []
        async for event in test.send_event_and_stream("Stream this response", timeout_seconds=90.0):
            events_received.append(event)
            event_type = event.get('type')

            if event_type == 'done':
                print(f"✓ Stream complete ({len(events_received)} events)")
                break

        assert len(events_received) > 0, "Should receive at least one event"
        print(f"✓ Streaming works ({len(events_received)} events received)")


@pytest.mark.asyncio
async def test_agent_workflow_execution():
    """
    Test temporal workflow execution.

    Temporal agents can handle long-running tasks with retries and state management.
    Adjust timeout based on your workflow's expected duration.
    """
    async with test_agentic_agent(agent_name=AGENT_NAME) as test:
        response = await test.send_event(
            "Execute your workflow task here",
            timeout_seconds=120.0  # Longer timeout for complex workflows
        )

        assert_valid_agent_response(response)

        # Add assertions specific to your workflow's expected behavior
        # assert_agent_response_contains(response, "workflow completed")
        # assert len(response.content) > 200, "Workflow response should be detailed"


@pytest.mark.asyncio
async def test_agent_custom_scenario():
    """
    Add your custom test scenarios here.

    Example: Test specific functionality of your temporal agent
    """
    async with test_agentic_agent(agent_name=AGENT_NAME) as test:
        # Customize this test for your agent's specific behavior
        response = await test.send_event(
            "Your custom test message here",
            timeout_seconds=60.0
        )

        assert_valid_agent_response(response)

        # Add assertions specific to your agent's expected behavior
        # assert_agent_response_contains(response, "expected text")


if __name__ == "__main__":
    print(f"Run with: pytest tests/test_agent.py -v")
    print(f"Testing agent: {AGENT_NAME}")
    print("\nNote: Temporal agents may require longer timeouts")
